var thrift = require('../bin/index.js');
var Idl = require('./idl.js');
var settings = require('./settings.js');

var idl = new Idl();
var protocol = new thrift.protocol.Binary(idl);
var clientConnection = new thrift.transport.HttpClient(8888, '127.0.0.1');
var thriftClient = new thrift.Client(protocol, idl, clientConnection);
var server = new thrift.transport.HttpServer(
    '127.0.0.1', 8888, actionFactory, protocol, idl);

var requestCount = 1;
var structure = settings.testStructure;

var responseCount = 0;
var okResponseCount = 0;
var avr = 0;
var max = 0;
var min = 100000000;


console.log();

function actionFactory(message, response) {
  if (JSON.stringify(message.getPayload()['arg1']) ===
      JSON.stringify(structure)) {
    response('OK');
  } else {
    response('FAIL');
  }
}

function handleServerResponse(message) {
  responseCount++;
  var responseTime = Date.now() - requestTime;
  if (message.getPayload()['response'] === 'OK') {
    okResponseCount++;
  }
  max = responseTime > max ? responseTime : max;
  min = responseTime < min ? responseTime : min;
  avr += responseTime;

  if (responseCount === requestCount) {
    console.log('COMPLETE');
    console.log('Requests: ', requestCount);
    console.log('Success response: ', okResponseCount);
    console.log('avr: ', avr / requestCount);
    console.log('max: ', max);
    console.log('min: ', min);
  } else {
    requestTime = Date.now();
    thriftClient.sendRequest('testIncludedValue', [structure],
        handleServerResponse, console.log);
  }
}


var requestTime = Date.now();
thriftClient.sendRequest('testIncludedValue', [structure],
    handleServerResponse, console.log);

