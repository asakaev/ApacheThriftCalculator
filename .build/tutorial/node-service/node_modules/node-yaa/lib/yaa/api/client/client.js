

/**
 * @typedef {yaa.Step|?function(
 *    function(!yaa.Step), !yaa.ErrorHandler, ...)}
 */
yaa.api.client.Provider;


/**
 * @param {!yaa.api.client.Provider} provider
 * @return {!yaa.Step}
 */
yaa.api.client.session = function(provider) {
  var step = null;
  var head = null;
  var tail = null;

  /**
   * @param {!yaa.Step} result
   */
  function flush(result) {
    step = result;

    if (tail !== null) {
      tail.apply(result);

      while (tail !== head) {
        tail = tail.next();
        tail.apply(result);
      }

      tail = head = null;
    }
  }

  /**
   * @param {yaa.Error} error
   */
  function destroy(error) {
    step = null;

    if (tail !== null) {
      tail.break(error);

      while (tail !== head) {
        tail = tail.next();
        tail.break(error);
      }

      tail = head = null;
    }
  }

  /**
   * @this {yaa.Context}
   * @param {!yaa.CompleteHandler} complete
   * @param {!yaa.ErrorHandler} cancel
   * @param {...yaa.Input} var_args
   */
  function session(complete, cancel, var_args) {
    if (step === null) {
      var call = new yaa.api.client.__Call(
          this, complete, cancel, arguments);

      if (head === null) {
        tail = head = call;

        provider.call(this, flush, destroy, arguments[2]);
      } else {
        head = head.push(call);
      }
    } else {
      step.call(this, complete, cancel, arguments[2]);
    }
  }

  return session;
};
