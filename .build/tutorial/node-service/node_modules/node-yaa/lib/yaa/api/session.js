


/**
 * @constructor
 * @implements {yaa.api.ISession}
 * @param {yaa.Context} context
 */
yaa.api.__Session = function(context) {

  /**
   * @type {yaa.Context}
   */
  this.__context = context;

  /**
   * @type {yaa.api.__Task}
   */
  this.__head = null;

  /**
   * @type {yaa.api.__Task}
   */
  this.__tail = null;

  /**
   * @type {number}
   */
  this.__lock = 0;
};


/**
 * @inheritDoc
 */
yaa.api.__Session.prototype.schedule =
    function(complete, cancel, step, stateful) {
  var task = new yaa.api.__Task(complete, cancel, step, stateful);

  if (this.__head === null) {
    this.__head = this.__tail = task;
  } else {
    this.__tail = this.__tail.push(task);
  }

  this.__touch();
};


/**
 *
 */
yaa.api.__Session.prototype.__touch = function() {
  var task = this.__head;
  if (task !== null && this.__acquireLock(task.stateful())) {
    if (this.__head !== this.__head.next()) {
      this.__head = this.__head.next();
    } else {
      this.__head = this.__tail = null;
    }

    task.call(this, this.__releaseLock, this.__context);

    this.__touch();
  }
};


/**
 * @param {boolean} stateful
 * @return {boolean}
 */
yaa.api.__Session.prototype.__acquireLock = function(stateful) {
  if (stateful) {
    return this.__acquireWriteLock();
  }

  return this.__acquireReadLock();
};


/**
 * @return {boolean}
 */
yaa.api.__Session.prototype.__acquireReadLock = function() {
  if (this.__lock >= 0) {
    this.__lock += 1;

    return true;
  }

  return false;
};


/**
 * @return {boolean}
 */
yaa.api.__Session.prototype.__acquireWriteLock = function() {
  if (this.__lock === 0) {
    this.__lock = -1;

    return true;
  }

  return false;
};


/**
 *
 */
yaa.api.__Session.prototype.__releaseLock = function() {
  if (this.__lock > 0) {
    this.__lock -= 1;
  } else {
    this.__lock = 0;
  }

  this.__touch();
};
