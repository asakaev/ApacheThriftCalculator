var yaa = require('../../../bin/index.js');
var test = require('../../test.js');
var cases = [];
var context = {};

module.exports = test(cases, __filename.substr(__dirname.length + 1), context);


/**
 * @this {Array}
 * @param {!yaa.CompleteHandler} complete
 * @param {!yaa.ErrorHandler} cancel
 * @param {string} key
 */
function pushToContext(complete, cancel, key) {
  var context = this;

  setTimeout(function() {
    context.push(key);
    complete();
  }, Math.floor(10 * Math.random()));
}


/**
 * @param {number} size
 */
function countdown(size) {
  size += 1;

  /**
   * @param {!yaa.CompleteHandler} complete
   * @param {!yaa.ErrorHandler} cancel
   */
  function countdown(complete, cancel) {
    var result = size -= 1;
    if (result >= 1) {
      setTimeout(complete, Math.floor(100 * Math.random()), result);
    } else {
      complete();
    }
  }

  return countdown;
}


cases.push(yaa.assert.outputEquals(
    yaa.use(yaa.proc.sequence(yaa.nop(), countdown(10)), yaa.no()),
    yaa.no(), 'Proc method proxy input.'));


cases.push(yaa.assert.outputEquals(
    yaa.use(yaa.proc.sequence(yaa.nop(), countdown(10)), yaa.yes()),
    yaa.yes(), 'Proc method proxy input.'));

cases.push(yaa.assert.outputEquals(
    yaa.use(yaa.proc.sequence(yaa.nop(), countdown(10), yaa.insert(context)), yaa.no()),
    yaa.insert(context), 'Proc method return output.'));


cases.push(yaa.bind(yaa.sequence([
  yaa.proc.sequence(pushToContext, countdown(10)),
  yaa.assert.contextDeepEquals([10, 9, 8, 7, 6, 5, 4, 3, 2, 1], 'Context ordered.')
]), []));


cases.push(yaa.bind(yaa.sequence([
  yaa.proc.sequence(pushToContext, countdown(1)),
  yaa.assert.contextDeepEquals([1], 'Context correct.')
]), []));
