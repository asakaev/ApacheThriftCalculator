


/**
 * @constructor
 * @implements {thrift.IValueKeeper}
 *
 * @param {!thrift.protocol.IProtocol} protocol
 */
thrift.protocol.MessageKeeperBase = function(protocol) {

  /**
   * @type {!thrift.protocol.IProtocol}
   */
  this.__protocol = protocol;

  /**
   * @type {!thrift.ISchema}
   */
  this.__idl = protocol.getIdl();

  /**
   * @type {number}
   */
  this.__type = 0;

  /**
   * @type {!Object}
   */
  this.__result = {};

  /**
   * @type {string}
   */
  this.__name = '';

  /**
   * @type {number}
   */
  this.__id = -1;

  /**
   * @type {boolean}
   */
  this.__isHeaderComplete = false;

  /**
   * @type {boolean}
   */
  this.__isComplete = false;
};


/**
 * @inheritDoc
 */
thrift.protocol.MessageKeeperBase.prototype.isComplete = function() {
  return this.__isComplete;
};


/**
 * @inheritDoc
 */
thrift.protocol.MessageKeeperBase.prototype.isHeaderComplete = function() {
  return this.__isHeaderComplete;
};


/**
 * @inheritDoc
 */
thrift.protocol.MessageKeeperBase.prototype.get = function() {
  return this.__result;
};


/**
 * @inheritDoc
 */
thrift.protocol.MessageKeeperBase.prototype.processHeader =
    function(cursor, chunk) {};


/**
 * @inheritDoc
 */
thrift.protocol.MessageKeeperBase.prototype.applyData = function(structure) {
  this.__isComplete = true;

  var value = null;
  var methodDefinition = this.__idl.getMethodDefinition(this.__name);

  if (methodDefinition !== null) {
    if (this.__type === thrift.definition.MessageType.EXCEPTION) {
      value = structure[1];
    }

    if (this.__type === thrift.definition.MessageType.CALL) {
      value = [];

      for (var id in structure) {
        var parameter = methodDefinition.getParameter(id);
        if (parameter !== null) {
          value[parameter.getId() - 1] = thrift.convertNestedStructure(
              structure[id], parameter.getFullType(), this.__idl);
        }
      }
    }

    if (this.__type === thrift.definition.MessageType.REPLY) {
      var fullReturnType = methodDefinition.getReturnType();
      var keysLength = structure instanceof Object ?
          Object.keys(structure).length : 0;

      if (structure[0] !== undefined) {
        value = thrift.convertNestedStructure(
            structure[0], fullReturnType, this.__idl);
      } else if (keysLength > 0) {
        this.__type = thrift.definition.MessageType.EXCEPTION;
        value = structure;
      }
    }
  } else {
    this.__type = thrift.definition.MessageType.EXCEPTION;
  }

  this.__result =
      new thrift.Message(this.__name, this.__type, this.__id, value);
};


/**
 * @inheritDoc
 */
thrift.protocol.MessageKeeperBase.prototype.getType = function() {
  return this.__type;
};


/**
 * @return {number}
 */
thrift.protocol.MessageKeeperBase.prototype.getId = function() {
  return this.__id;
};


/**
 * @return {string}
 */
thrift.protocol.MessageKeeperBase.prototype.getName = function() {
  return this.__name;
};
