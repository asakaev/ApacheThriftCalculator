var thrift = require('../bin/index.js');
var Idl = require('./idl.js');

var idl = new Idl();
var protocol = new thrift.protocol.Binary(idl);
var clientConnection = new thrift.transport.HttpClient(8888, '127.0.0.1');
var thriftClient = new thrift.Client(protocol, idl, clientConnection);
var server = new thrift.transport.HttpServer('127.0.0.1', 8888, actionFactory, protocol, idl);

var longStr = (new Array(10 * 1024 * 1000)).join('$');
console.log(longStr.length);
var str1 = new Idl.TestStructure(123456789, 'IA_STRINGA', true);
var testStruct = new Idl.TestStructure2([str1, str1, str1, str1, str1], {
  'qwe': 'qwe',
  'asd': 'asd',
  'asd': 'asd',
  'zxc': 'zxc'});

var payload = longStr;

function actionFactory(message, response) {
  console.log('payload length', message.getPayload()['arg1'].length);
  response('OK');
}

function handleServerResponse(message) {
  console.log('payload length', message.getPayload()['response'].length);
  console.log('CLIENT OK');
};


//
//thriftClient.sendRequest('testIncludedValue', [payload],
//    function(mess){console.log('CLIENT OK', mess)}, console.log);

  thriftClient.sendRequest('testLongString', ['123'],
      handleServerResponse, console.log);
