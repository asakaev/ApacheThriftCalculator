var thrift = require('../bin/index.js');
var Idl = require('./idl.js');

var idl = new Idl();
var protocol = new thrift.protocol.Binary(idl);
var thriftClient =
    new thrift.transport.HttpClient(protocol, idl, 8888, '127.0.0.1');
var server = new thrift.transport.HttpServer(
    '127.0.0.1', 8888, actionFactory, protocol, idl);

var requestCount = 1;
var longStr = (new Array(1 * 1024 * 1000)).join('$');

var responseCount = 0;
var okResponseCount = 0;
var avr = 0;
var max = 0;
var min = 100000000;

function actionFactory(message, response) {
  if (message.getPayload()['arg1'].length === longStr.length) {
    response('OK');
  } else {
    response('FAIL');
  }
}

function handleServerResponse(message) {
  responseCount++;
  var responseTime = Date.now() - requestTime;
  if (message.getPayload()['response'] === 'OK') {
    okResponseCount++;
  }
  max = responseTime > max ? responseTime : max;
  min = responseTime < min ? responseTime : min;
  avr += responseTime;

  if (responseCount === requestCount) {
    console.log('COMPLETE');
    console.log('Requests: ', requestCount);
    console.log('Success response: ', okResponseCount);
    console.log('avr: ', avr / requestCount);
    console.log('max: ', max);
    console.log('min: ', min);
  } else {
    requestTime = Date.now();
    thriftClient.sendRequest('testLongString', [longStr],
        handleServerResponse, console.log);
  }
};


var requestTime = Date.now();
thriftClient.sendRequest('testLongString', [longStr],
    handleServerResponse, console.log);

