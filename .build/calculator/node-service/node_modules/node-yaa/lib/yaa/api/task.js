


/**
 * @constructor
 * @param {!yaa.CompleteHandler} complete
 * @param {!yaa.ErrorHandler} cancel
 * @param {!yaa.Step} step
 * @param {boolean} stateful
 */
yaa.api.__Task = function(complete, cancel, step, stateful) {

  /**
   * @type {!yaa.api.__Task}
   */
  this.__next = this;

  /**
   * @type {!yaa.Step}
   */
  this.__step = step;

  /**
   * @type {!yaa.CompleteHandler}
   */
  this.__complete = complete;

  /**
   * @type {!yaa.ErrorHandler}
   */
  this.__cancel = cancel;

  /**
   * @type {boolean}
   */
  this.__stateful = stateful;
};


/**
 * @return {boolean}
 */
yaa.api.__Task.prototype.stateful = function() {
  return this.__stateful;
};


/**
 * @param {yaa.Context} context
 * @param {function()} callback
 * @param {yaa.Context} sessionContext
 */
yaa.api.__Task.prototype.call = function(context, callback, sessionContext) {
  var done = false;
  var self = this;

  /**
   * @param {...yaa.Output} var_args Результат выполнения сценария.
   */
  function localComplete(var_args) {
    if (!done && (done = true)) {
      self.__complete(arguments[0]);

      callback.call(context);
    }
  }

  /**
   * @param {yaa.Error} error Сообщение ошибки.
   */
  function localCancel(error) {
    if (!done && (done = true)) {
      callback.call(context);
    }

    self.__cancel(error);
  }

  this.__step.call(sessionContext, localComplete, localCancel);
};


/**
 * @param {!yaa.api.__Task} call
 * @return {!yaa.api.__Task}
 */
yaa.api.__Task.prototype.push = function(call) {
  return this.__next = call;
};


/**
 * @return {!yaa.api.__Task}
 */
yaa.api.__Task.prototype.next = function() {
  return this.__next;
};
